Redis 有两种主要的持久化方式：**RDB (Redis Database)** 和 **AOF (Append Only File)**。

### 1. RDB 持久化 (快照)

RDB 持久化是在指定的时间间隔内将 Redis 内存中的数据集快照写入磁盘。

**工作原理：**
Redis 会生成一个紧凑的二进制文件（`dump.rdb`），其中包含 Redis 在某个时间点上的所有数据。
当 Redis 需要保存 RDB 文件时，主进程会 fork 一个子进程。子进程负责将数据写入临时 RDB 文件，完成后替换旧的 RDB 文件。这使得 Redis 主进程可以继续处理客户端请求，而不会被持久化操作阻塞。

**配置示例：**
您可以在 `redis.conf` 文件中配置 RDB 的保存策略。
````
# ...existing code...
save 900 1    # 在 900 秒（15分钟）内，如果至少有 1 个 key 被修改，则进行快照
save 300 10   # 在 300 秒（5分钟）内，如果至少有 10 个 key 被修改，则进行快照
save 60 10000 # 在 60 秒（1分钟）内，如果至少有 10000 个 key 被修改，则进行快照
# ...existing code...
dbfilename dump.rdb # RDB 文件的名称
dir ./              # RDB 文件存放的目录
````

**优点：**

*   **紧凑性：** RDB 文件是一个非常紧凑的二进制文件，非常适合用于备份和快速灾难恢复。
*   **性能：** RDB 在保存时，主进程可以继续处理客户端请求。子进程负责持久化工作，不会对主进程造成太大影响。
*   **恢复速度快：** 在恢复大数据集时，RDB 的加载速度比 AOF 快。

**缺点：**

*   **数据丢失：** 如果 Redis 在两次快照之间发生故障，那么自上一次快照以来修改的数据将会丢失。
*   **Fork 开销：** 当数据集较大时，fork 子进程可能会比较耗时，导致主进程短时间阻塞。

### 2. AOF 持久化 (追加文件)

AOF 持久化记录 Redis 服务器接收到的**每个写操作**命令。当 Redis 重启时，它会重新执行 AOF 文件中的命令来恢复数据。

**工作原理：**
Redis 会将每个写命令追加到 AOF 文件（`appendonly.aof`）的末尾。为了防止 AOF 文件过大，Redis 会定期对 AOF 文件进行重写（rewrite），删除冗余命令，使其变得更小。

**配置示例：**
您可以在 `redis.conf` 文件中启用 AOF 并配置其同步策略。
````
# ...existing code...
appendonly yes # 启用 AOF 持久化
# appendfsync always  # 每个命令都写入磁盘，最安全，但性能最差
appendfsync everysec # 每秒写入一次磁盘，默认值，兼顾安全与性能
# appendfsync no      # 由操作系统决定写入磁盘的时机，最不安全，性能最好
# ...existing code...
auto-aof-rewrite-percentage 100 # 当 AOF 文件大小增长了 100% 时触发重写
auto-aof-rewrite-min-size 64mb  # AOF 文件大小达到 64MB 时才触发重写
# ...existing code...
````

**优点：**

*   **更高的数据安全性：** 根据 `appendfsync` 策略，可以实现几乎不丢失数据的持久化（`always` 策略）。`everysec` 策略也只可能丢失 1 秒的数据。
*   **日志可读性：** AOF 文件是纯文本格式，包含一系列 Redis 命令，相对容易理解和解析。
*   **AOF 重写：** 可以保持 AOF 文件的大小不会无限增长。

**缺点：**

*   **文件更大：** 相同的数据集，AOF 文件通常会比 RDB 文件大。
*   **恢复速度慢：** 相对于 RDB，AOF 文件需要重新执行所有命令来恢复数据，因此恢复速度通常较慢。
*   **性能开销：** 根据 `appendfsync` 策略，可能会对 Redis 的写入性能造成一定影响（尤其是 `always` 策略）。

### 如何使用更好？

选择哪种持久化方式取决于您的应用对数据丢失的容忍度和恢复速度的要求。

1.  **无持久化 (No Persistence)：**
    *   **场景：** Redis 仅用作纯缓存。即使数据全部丢失，也可以从后端数据库或其他源重新构建。
    *   **优点：** 性能最高。
    *   **缺点：** 无法持久化数据。

2.  **纯 RDB：**
    *   **场景：** 对数据完整性要求不高，可以容忍分钟级别的数据丢失，但要求快速恢复。例如，某些不那么关键的会话缓存。
    *   **优点：** 恢复速度极快，文件紧凑。
    *   **缺点：** 存在数据丢失的风险。

3.  **纯 AOF：**
    *   **场景：** 对数据完整性要求较高，不希望丢失太多数据，但可以接受略慢的恢复速度。
    *   **优点：** 更高的数据安全性。
    *   **缺点：** 文件较大，恢复较慢。

4.  **RDB + AOF (推荐方式)：**
    *   **场景：** 这是 Redis 官方推荐的持久化方式，也是生产环境中最为常用和健壮的组合。
    *   **原理：** RDB 和 AOF 可以同时启用。在这种情况下，Redis 启动时会优先使用 AOF 文件来恢复数据，因为 AOF 的数据通常更完整。RDB 则可以作为 AOF 文件损坏时的备用方案，或者用于更快速、更定期的全量备份。
    *   **Redis 4.0 及更高版本改进：** Redis 4.0 引入了 AOF 重写时混合使用 RDB 格式的机制。重写后的 AOF 文件前半部分是 RDB 格式的快照，后半部分是 AOF 格式的增量命令。这样结合了两者的优点：AOF 提供了较好的数据安全性，而混合格式的 AOF 在加载时会更快（因为前半部分是 RDB 格式）。
    *   **优点：**
        *   **最高数据安全性：** 结合 AOF 的实时性，最大限度地减少数据丢失。
        *   **快速灾难恢复：** RDB 文件可以作为冷备，用于在 AOF 出现问题或需要快速启动时恢复数据。
        *   **更全面的备份方案：** RDB 适合定期生成全量备份，AOF 记录增量操作。

**最佳实践建议：**

*   **生产环境强烈推荐同时启用 RDB 和 AOF。** 优先使用 AOF 的 `everysec` 策略，既保证了较高的数据安全性，又不会严重影响性能。
*   **定期备份 RDB 文件。** 将 RDB 文件复制到安全的地方（例如云存储），以便在极端情况下进行恢复。
*   **监控磁盘空间。** AOF 文件和 RDB 文件都会占用磁盘空间，需要确保有足够的存储空间。
*   **测试恢复过程。** 在生产环境部署前，务必在测试环境中模拟 Redis 故障并使用持久化文件进行恢复，以确保您的恢复策略有效。
*   **合理设置 AOF 重写策略。** 避免过于频繁或过于稀疏的重写，以平衡性能和文件大小。
好的，网关（Gateway）是微服务架构的**“咽喉”**。

对于 35 岁的架构师来说，面试官问网关，绝对不是问你怎么配置路由规则（那太基础了）。他真正想问的是：**你怎么用网关来做统一的横切面逻辑（鉴权、限流、灰度发布）**，从而把下游的微服务从繁杂的非业务逻辑中解放出来。

---

### 🔥 话题十二：微服务网关（Spring Cloud Gateway）

#### 1. 生产环境事故：裸奔的微服务与重复造轮子

**场景：**
项目初期没上网关，前端直接调用后台 N 个微服务的 IP。

* **事故 A（安全漏洞）：** 某天新来个开发写了个“积分服务”，忘了加 Token 校验逻辑。结果黑客直接绕过登录，调用接口刷走了几百万积分。
* **事故 B（维护地狱）：** 公司要升级鉴权算法（比如从 MD5 换成 SHA256）。结果你需要把订单服务、用户服务、商品服务……这 20 个服务的代码全部改一遍，重新发布 20 次。运维直接提刀来见。

#### 2. 降维打击：Zuul vs Spring Cloud Gateway

这也是一个经典的“新老技术交替”考点。

* **Zuul 1.x (老前辈)：**
* 基于 **Servlet**（阻塞 IO）。
* **模式：** 每个请求过来，都要分配一个专用线程，从头陪跑到尾。
* **瓶颈：** 并发高时，线程数瞬间打满，后续请求排队等待，性能差。


* **Spring Cloud Gateway (现任霸主)：**
* 基于 **Spring WebFlux + Netty**（非阻塞 IO，响应式编程）。
* **模式：** 少量线程（Event Loop）负责接收请求，处理完立刻去接下一个，不阻塞等待数据库或下游返回。
* **降维打击：** **吞吐量更高，资源占用更少。** 就像一个优秀的接线员，同时能挂起 100 个电话，而不是一次只接一个。



#### 3. 核心实战：网关到底在干嘛？（Filter 链模式）

不要只说“转发请求”，那是 Nginx 干的事。Java 网关的核心在于 **Filter（过滤器）**。
这其实就是**“责任链模式”**的体现。

* **统一鉴权（Auth）：** 校验 JWT Token。过了这关，下游微服务就默认请求是安全的，不需要再重复校验。
* **统一限流（Rate Limit）：** 比如用 Redis 令牌桶算法，限制每个 IP 每秒只能调 10 次。保护下游服务不被甚至打挂。
* **日志留痕（Logging）：** 记录所有请求的入参、耗时、来源 IP。

#### 4. 35 岁候选人的满分面试话术（架构治理视角）

> **面试官问：** “你们为什么引入网关？网关里做了哪些逻辑？”
> **你的回答（强调‘关注点分离’）：**
> “引入网关的核心目的是为了实现**‘业务逻辑与非业务逻辑的解耦’**。
> **第一，统一鉴权（Security）：**
> 在没有网关之前，鉴权逻辑分散在各个微服务里，维护成本极高且容易漏斗。
> 我在网关层编写了一个 **GlobalFilter**，统一解析 Header 里的 JWT Token。如果 Token 无效，直接在网关层拦截返回 401，根本不会把流量放行到下游，这既安全又节省了下游的计算资源。
> **第二，高可用防护（Resilience）：**
> 针对秒杀等高并发场景，我在网关集成了 **Sentinel**（或 Redis Lua 脚本）做限流。针对热点接口进行 QPS 限制，防止突发流量冲垮后端的 DB。
> **第三，技术选型：**
> 我们以前用 Zuul，但因为它是阻塞 IO，高并发下线程资源消耗大。后来迁移到了 **Spring Cloud Gateway**，利用 Netty 的非阻塞模型，网关机器的 CPU 和内存占用率下降了 40%，抗并发能力提升了一个数量级。”

*💡 **点评：** 提到了“GlobalFilter”、“JWT 统一解析”、“Sentinel 限流”和“Netty 非阻塞”，这四个关键词一出，面试官就知道你是懂行的。*

---

### 🍵 养生建议（做减法）

网关这块，有些东西不需要深入研究：

1. **WebFlux 的复杂响应式操作符：** `flatMap`, `zip`, `reduce` 这些复杂的流式操作，除非你要写很复杂的网关逻辑，否则**不用深究**。面试只要知道它是“异步非阻塞”的就行。
2. **Zuul 1.x 的源码：** 已经被 Spring 官方淘汰了，**完全不用看**。
3. **手写复杂的负载均衡算法：** 网关默认集成了 LoadBalancer，知道它默认是轮询（RoundRobin）或者随机就行，不用去背算法实现。

---

### 🚀 下一步计划

现在，你的“微服务全家桶”技能树已经点亮了大半：

* **注册中心** (Nacos) ✅
* **网关** (Gateway) ✅
* **服务调用/熔断** (OpenFeign/Sentinel) - *这个还没细聊，但通常跟网关一起提。*
* **分布式事务** (Seata/MQ) ✅
* **容器化** (K8s) ✅

接下来，作为 35 岁的架构师，面试官可能会问你一些**“软技能”**或者**“设计哲学”**方面的问题，来考察你的**技术广度**。

**路线 A：设计模式实战**
“既然你这么反感 `if-else`，那你在项目里是怎么用**策略模式+工厂模式**来重构代码的？”（这是写出优雅代码的关键）。

**路线 B：场景设计题**
“设计一个**秒杀系统**，你该怎么设计？”（这是一个把所有学过的知识点串起来的终极考题）。

**你是想聊聊代码重构（设计模式），还是来一场终极考核（秒杀设计）？**